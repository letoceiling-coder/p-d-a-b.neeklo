# План внедрения: веб-сервис анализа договоров

Документ описывает поэтапный план реализации веб-сервиса по ТЗ «Веб-сервис анализа договоров» на базе UI ai-hub-suite (GPT-style dashboard). Логика строго в рамках ТЗ, без лишних модулей и без Telegram в веб-интерфейсе.

---

## 1. Исходные данные

| Параметр | Значение |
|----------|----------|
| База UI | https://github.com/Neeklo1606/ai-hub-suite.git |
| Формат | Web Interface (GPT-style dashboard) |
| Текущий проект | Laravel + Vue 3 (админка), есть сервисы анализа договоров (Telegram) |
| Авторизация | Регистрация по invite-коду |
| Роли | Admin, Employee |

---

## 2. Общая архитектура

### 2.1 Подход к UI

- **Вариант A:** Клонировать репозиторий ai-hub-suite в подпапку (например `frontend-app/`) и подключать к Laravel API (отдельный SPA или встроенный через Vite).
- **Вариант B:** Реализовать в текущем Vue-проекте новый модуль «Анализ договора» с layout в стиле ai-hub-suite: левая панель (чаты/история), центральная зона (чат + загрузка), без изменения общей структуры репозитория.

Рекомендация: если ai-hub-suite — готовый GPT-like шаблон с роутингом чатов, использовать **Вариант A** и настроить API Laravel под его формат. Если репозиторий недоступен или структура не совпадает — **Вариант B**: внедрить GPT-style layout и экраны в текущем `resources/js/`.

### 2.2 Разделение зон приложения

1. **Публичная зона:** страница входа / регистрации по invite-коду.
2. **Зона сотрудника (Employee):** интерфейс «Анализ договора» — список анализов (чаты), рабочая область (загрузка, результат, чат по договору), профиль.
3. **Зона администратора (Admin):** всё то же + настройки, управление пользователями, генерация invite-кодов, просмотр всех анализов, настройка срока хранения, управление API-ключами.

---

## 3. Этапы внедрения

### Фаза 0: Подготовка и база UI

| Шаг | Задача | Результат |
|-----|--------|------------|
| 0.1 | Клонировать/изучить ai-hub-suite: структура роутов, компоненты сайдбара и чата | Решение: Вариант A или B |
| 0.2 | Настроить окружение: точка входа SPA (например `/app` или `/`), API base URL на Laravel | Работающий фронтенд против Laravel |
| 0.3 | Определить общие компоненты: Sidebar (чаты + «Новый анализ» + поиск + настройки + профиль), центральная область (header чата, блок ввода, блок вывода) | Переиспользуемые компоненты |

---

### Фаза 1: Авторизация и роли

| Шаг | Задача | Результат |
|-----|--------|------------|
| 1.1 | Модель `User` (если ещё нет для веб): email/пароль, роль (`admin` / `employee`), привязка к invite-коду | Миграция `users` + роли |
| 1.2 | Модель `InviteCode`: код, создатель (admin), использован (user_id), срок действия | Миграция `invite_codes` |
| 1.3 | API: генерация invite-кода (только admin), регистрация по коду (guest), логин/логаут (Sanctum или session) | Эндпоинты регистрации и авторизации |
| 1.4 | Middleware/проверки: разграничение Admin / Employee; доступ к «настройкам» и «все анализы» только для Admin | Роли работают в API и роутинге |
| 1.5 | Frontend: экран входа, экран регистрации по invite-коду, хранение токена/сессии, редирект по ролям | Пользователь входит по коду и попадает в интерфейс анализов |

---

### Фаза 2: Модель «Анализ» как чат и API

| Шаг | Задача | Результат |
|-----|--------|------------|
| 2.1 | Расширить/адаптировать модель анализа для веб: `user_id` (владелец), название (ИНН + дата), статус (`processing` / `ready`), связь с файлами (ссылки/метаданные, не сами файлы), JSON результата, PDF (путь или blob reference) | Миграции/модель `ContractAnalysis` для веба |
| 2.2 | Хранение файлов: по ТЗ — только ссылки/метаданные в истории; сами файлы можно хранить временно на время обработки и удалять после генерации отчёта, либо не сохранять (как в текущем DEVELOPMENT_PLAN). Уточнить в ТЗ: «Файлы (ссылки)» — сохранять только факт и имена | Таблица/поля для истории (файлы как ссылки или только имена) |
| 2.3 | API: создание «нового анализа» (новый чат) — POST, возврат id и название; список анализов пользователя (для Employee — свои, для Admin — все с фильтром); поиск по истории (по названию/ИНН/дате) | Эндпоинты CRUD для анализов как чатов |
| 2.4 | Сообщения внутри чата: модель `AnalysisMessage` (роль: user/assistant, текст, привязка к analysis_id). API: отправка сообщения (уточняющий вопрос), получение истории сообщений | Чат внутри анализа |

---

### Фаза 3: Загрузка документов и валидация

| Шаг | Задача | Результат |
|-----|--------|------------|
| 3.1 | API загрузки: multipart для одного/нескольких файлов; форматы: PDF, DOC/DOCX, JPG, PNG; ZIP — распаковка на сервере, отбор только PDF, DOC/DOCX, JPG (PNG по ТЗ п.8 можно не анализировать или ограничить). Лимит 30–40 страниц (по количеству страниц или по размеру) | Эндпоинт upload с валидацией |
| 3.2 | Ответы API: «Файл загружен», «Файл отклонён — неподдерживаемый формат», «Обнаружен ZIP — выполняется распаковка» (при необходимости асинхронный статус) | Человекочитаемые коды/сообщения для UI |
| 3.3 | Использовать существующие сервисы: `ContractFileHandler`, распаковка ZIP, отбор допустимых форматов; лишние файлы отклонять | Переиспользование кода из текущего проекта |

---

### Фаза 4: Обработка и AI-выжимка

| Шаг | Задача | Результат |
|-----|--------|------------|
| 4.1 | Запуск анализа после загрузки: извлечение текста (`DocumentTextExtractor`), вызов AI (`ContractAnalysisService`), сохранение структурированной выжимки в формате п. 3.4 ТЗ (Предмет договора, Начало/окончание контракта, Сумма, Спецсчёт, Заявка, Оплата, Документы для оплаты, Штрафы, Риски, Расторжение, Транспорт, Квалификация, Расценки, Разрешения, ИНН и т.д.) | Выжимка в JSON и тексте |
| 4.2 | Индикатор обработки: API статуса анализа (например GET analysis/:id/status) с этапами: «Извлечение текста», «Проверка контрагента», «Формирование отчёта» (или единый «Идёт анализ договора») | Frontend показывает loader и текст этапа |
| 4.3 | Очередь/фоновые задачи: при длительной обработке — job (Laravel Queue), обновление статуса в БД; фронтенд — опрос или WebSocket по желанию (минимум — опрос) | Стабильная обработка без таймаутов |

---

### Фаза 5: Проверка контрагента

| Шаг | Задача | Результат |
|-----|--------|------------|
| 5.1 | Модель/структура данных: блок «Проверка контрагента» с пунктами: ФССП, ФНС (ГИР БО), судебные дела, массовый адрес, массовый директор, задолженность, нулевая отчётность, признаки ненадёжности. По каждому: статус (OK / Risk / Warning), источник, дата проверки | Схема в JSON и в БД (или только JSON в результате анализа) |
| 5.2 | Реализация: интеграция с внешними API (ФССП, ФНС и т.д.) или заглушки с мок-данными; вызов после извлечения ИНН из выжимки | Сервис проверки контрагента |
| 5.3 | Сохранение результата проверки в `ContractAnalysis` и вывод в UI в блоке «Проверка контрагента» | Отображение в центральной зоне |

---

### Фаза 6: Результат в UI и чат

| Шаг | Задача | Результат |
|-----|--------|------------|
| 6.1 | Блок Output: карточки «Выжимка договора» (все поля п. 3.4 ТЗ) и «Проверка контрагента» (все пункты со статусами). Structured result cards без лишних паттернов | Компоненты вывода результата |
| 6.2 | Работа внутри чата: пользователь задаёт уточняющий вопрос → API отправки сообщения → AI (контекст: выжимка + история сообщений) → ответ в чат; сохранение сообщений в истории | Уточняющие вопросы и детализация по пункту |
| 6.3 | Header анализа: название (ИНН + дата), статус «В обработке» / «Готово», кнопки «Скачать PDF» и «Повторный анализ» | Действия в шапке чата |

---

### Фаза 7: PDF-отчёт и скачивание

| Шаг | Задача | Результат |
|-----|--------|------------|
| 7.1 | Генерация PDF после завершения анализа: реквизиты, выжимка, проверка контрагента, источники, дата формирования. Библиотека: Dompdf или Snappy (wkhtmltopdf) или аналог | Сервис генерации PDF |
| 7.2 | Хранение: PDF сохранять (файл или storage) и привязывать к `ContractAnalysis`; срок хранения — по настройке (1/3/6/12 месяцев) | Ссылка на файл в записи анализа |
| 7.3 | API: GET analysis/:id/download-pdf — отдача файла (только для владельца или Admin) | Кнопка «Скачать PDF» работает |

---

### Фаза 8: История и настройки хранения

| Шаг | Задача | Результат |
|-----|--------|------------|
| 8.1 | История: пользователь, дата, файлы (ссылки/имена), JSON результата, PDF — уже заложено в модель; список в сайдбаре = список анализов с названием (ИНН + дата) и поиском | Левая панель = список чатов с поиском |
| 8.2 | Настройка срока хранения: админ задаёт 1 / 3 / 6 / 12 месяцев; планировщик (Laravel Schedule) или команда удаляет анализы и PDF старше срока | Конфиг + команда `contract:cleanup` (расширить под веб) |
| 8.3 | Удаление файлов и записей: при очистке — удалять PDF с диска и записи анализов | Без «мусора» в storage |

---

### Фаза 9: Админ-панель (веб)

| Шаг | Задача | Результат |
|-----|--------|------------|
| 9.1 | Управление пользователями: список пользователей, роли, отключение доступа (без удаления записей анализов по желанию) | Раздел «Пользователи» |
| 9.2 | Генерация invite-кодов: форма (количество, срок действия), список выданных кодов и статус (использован/нет) | Раздел «Invite-коды» |
| 9.3 | Просмотр всех анализов: для Admin — список всех анализов с фильтром по пользователю/дате; переход к просмотру результата и PDF | Уже есть заготовки в текущем проекте — адаптировать под user_id |
| 9.4 | Настройка срока хранения: выбор 1/3/6/12 месяцев в настройках | Страница настроек хранения |
| 9.5 | Управление API-ключами: существующая функциональность AiKeys — оставить, доступ только Admin | Без изменений или перенос в «Настройки» |

---

### Фаза 10: Левая панель и навигация (GPT-style)

| Шаг | Задача | Результат |
|-----|--------|------------|
| 10.1 | Элементы сайдбара: «+ Новый анализ», список анализов (название = ИНН + дата), поиск по истории, «Настройки», «Профиль пользователя» | Финальная вёрстка сайдбара |
| 10.2 | Новый анализ = новый чат: создание записи анализа и переход в центральную зону с пустым состоянием (блок загрузки) | Без тупиков |
| 10.3 | Выбор анализа из списка: загрузка сообщений и результата (если есть), отображение в центральной зоне | Консистентное состояние чата |

---

### Фаза 11: Обработка ZIP (уточнение)

| Шаг | Задача | Результат |
|-----|--------|------------|
| 11.1 | По ТЗ п.8: распаковка ZIP, анализ только PDF, DOCX, JPG; игнорировать PNG не по теме, XLS, TXT, системные файлы | Логика в `ContractFileHandler` (или аналоге) |
| 11.2 | Сообщение пользователю: «Обнаружен ZIP — выполняется распаковка» при загрузке ZIP | UX по ТЗ |

---

### Фаза 12: Финальная проверка и критерии готовности

| Критерий (по ТЗ п.12) | Проверка |
|------------------------|----------|
| Интерфейс соответствует ai-hub-suite | Layout: сайдбар + центральная зона, без лишних модулей |
| Новый анализ создаёт новый чат | Кнопка «Новый анализ» → новая запись → экран загрузки |
| История работает | Список в сайдбаре, поиск, открытие прошлых анализов |
| PDF генерируется | Кнопка «Скачать PDF» отдаёт файл |
| Контрагент проверяется | Блок «Проверка контрагента» с пунктами и статусами |
| Нет UI-тупиков | Все кнопки и переходы ведут к ожидаемым экранам |
| Логика строго по ТЗ | Нет лишних бизнес-модулей, нет Telegram в веб-интерфейсе |

---

## 4. Зависимости этапов

```
Фаза 0 (UI база) ──┬──► Фаза 1 (Auth, роли) ──► Фаза 2 (Модель анализ/чат) ──► Фаза 3 (Загрузка)
                   │                                                                  │
                   └──────────────────────────────────────────────────────────────────┼──► Фаза 4 (AI выжимка) ──► Фаза 5 (Контрагент)
                                                                                      │
Фаза 6 (Output + чат) ◄───────────────────────────────────────────────────────────────┘
        │
        ├──► Фаза 7 (PDF) ──► Фаза 8 (История, срок хранения)
        │
        └──► Фаза 9 (Админ-панель)
                   
Фаза 10 (Сайдбар/навигация) зависит от 0, 1, 2, 6.
Фаза 11 (ZIP) — параллельно с Фазой 3.
Фаза 12 — после всех.
```

---

## 5. Рекомендуемый порядок работ

1. **Фаза 0** — определить источник UI (ai-hub-suite или текущий Vue) и собрать layout.
2. **Фаза 1** — авторизация по invite-коду и роли (Admin/Employee).
3. **Фаза 2** — модель анализа как «чат», API списка/создания/поиска, сообщения в чате.
4. **Фаза 3** — загрузка файлов (в т.ч. ZIP) и валидация.
5. **Фаза 4 и 5** — конвейер анализа (текст → AI → выжимка) и проверка контрагента.
6. **Фаза 6** — вывод результата в UI и чат с уточняющими вопросами.
7. **Фаза 7** — генерация и скачивание PDF.
8. **Фаза 8** — история, поиск, очистка по сроку хранения.
9. **Фаза 9** — админ-функции (пользователи, invite-коды, все анализы, настройки).
10. **Фаза 10** — доводка сайдбара и навигации под GPT-style.
11. **Фаза 11** — уточнение обработки ZIP по ТЗ.
12. **Фаза 12** — чек-лист готовности по ТЗ.

---

## 6. Риски и упрощения

- **ai-hub-suite недоступен:** реализовать GPT-style в текущем Vue (Фаза 0, Вариант B).
- **Внешние API контрагента (ФССП, ФНС):** на первом этапе — заглушки со статусами OK/Risk/Warning и датой; интеграцию вынести во второй этап.
- **Длинный анализ:** обязательное использование очереди (Queue) и статуса «В обработке», чтобы не упираться в таймауты HTTP.

---

## 7. Что не делать (по ТЗ п.9)

- Не реализовывать лишний функционал.
- Не добавлять новые бизнес-модули.
- Не усложнять UI.
- Не менять структуру ai-hub-suite (если используем Вариант A).
- Не внедрять Telegram в веб-сервис.

---

Документ можно дополнять по мере уточнения репозитория ai-hub-suite и выбора варианта интеграции (A или B).
