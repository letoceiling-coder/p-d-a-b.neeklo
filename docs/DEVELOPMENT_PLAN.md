# План разработки по ТЗ: бот анализа договоров

Документ связывает текущее состояние проекта с требованиями ТЗ и задаёт порядок разработки.

**Дополнение:** [TZ_UX_MENU_AUTH.md](./TZ_UX_MENU_AUTH.md) — постоянное меню, FSM-навигация, шаблонные сообщения, настройки, авторизация (только UX, без нового функционала анализа).

**Веб-сервис (GPT-style):** [IMPLEMENTATION_PLAN_WEB_SERVICE.md](./IMPLEMENTATION_PLAN_WEB_SERVICE.md) — план внедрения веб-интерфейса анализа договоров на базе ai-hub-suite (чаты, история, invite-коды, PDF, проверка контрагента).

---

## 1. Текущее состояние проекта

| Компонент | Статус | По ТЗ |
|-----------|--------|--------|
| Telegram webhook | Есть: /start, /admin, проверка одобренного admin | Загрузка документов только для admin — **добавить приём файлов** |
| Роли (BotUser) | `admin`, статусы pending/approved/rejected | Совпадает (загрузка — для admin) |
| AI (OpenAI, Gemini) | AiService, ключи и модели в админке | Использовать для анализа текста договора |
| Админ-панель | Бот, запросы доступа, AI Keys/Models | + История анализов, настройки анализа, логи |
| Хранение файлов | Не реализовано | **Файлы не хранить** — только в памяти на время обработки |
| Хранение результатов | Нет | Хранить только выжимки, срок 6 месяцев |

---

## 2. Соответствие ТЗ по разделам

### 3. Назначение бота
- Загрузка договоров и связанных документов → **реализовать приём и валидацию файлов**.
- Анализ текста с помощью AI → **использовать существующий AiService**.
- Структурированная выжимка → **новый промпт и парсинг ответа AI**.
- Выдача в Telegram → **отправка текста/форматов после анализа**.
- Не делать: юридическая экспертиза, правовая оценка — **не закладывать в промпт**.

### 4. Форматы документов
- **Поддерживаемые**: PDF, DOC/DOCX, JPG/PNG, ZIP.
- **Одиночная загрузка**: один PDF, один Word, набор изображений.
- **ZIP**: распаковка, анализ только PDF/DOC/DOCX/JPG/PNG; приоритет файлу с «договор» в названии.
- **Изображения**: только относящиеся к договору; лимит 5 фото на первом этапе; позже — выбор страниц по настройке.

### 5. Структура договора и анализ
- Структура нестабильная → **не жёсткий парсинг по разделам**, анализ всего текста.
- Первый этап: весь документ целиком, лимит 5 фото.

### 6. Данные для извлечения (16 пунктов)
Выжимка должна содержать (по возможности):
1. Предмет договора  
2. Цена договора  
3. Срок начала оказания услуг  
4. Срок окончания оказания услуг  
5. Срок предоставления заявки  
6. Условия использования спецсчёта  
7. Порядок оплаты (аванс, сроки, процедура)  
8. Необходимые документы для оплаты  
9. Ответственность сторон  
10. Размер ответственности  
11. Подсудность / порядок разрешения споров  
12. Требования к транспорту  
13. Требования к квалификации персонала  
14. Условия расторжения  
15. Специальные разрешения  
16. Единичные расценки (если есть)  

Формат: структурированная выжимка 15–20 пунктов.

### 7. Поведение при ошибках
При неподдерживаемых форматах, нерелевантных или повреждённых файлах:
- Не продолжать обработку.
- Ответить одной фразой: **«Пожалуйста, загрузите договор или выбранные страницы договора.»**

### 8. Формат выдачи
- Текст в Telegram.
- Краткая и расширенная выжимка.
- JSON для админ-панели (при хранении и отображении).

### 9. Хранение данных
- История анализов у Заказчика (на нашем сервере).
- Исходные файлы **не сохраняем** — только в памяти/временные, удаление после обработки.
- Хранить только результаты анализа (выжимка, извлечённые поля).
- Срок хранения по умолчанию — 6 месяцев.

### 10. Авторизация
- Уже есть: запрос доступа (/admin), одобрение в админке (белый список).
- Админ может: добавлять/удалять сотрудников, настройки анализа, история запросов — часть уже есть, остальное в плане.

### 11. Админ-панель
- URL /admin, HTTPS, только для admin — уже так.
- Нужно добавить: история анализов, просмотр результатов (в т.ч. JSON), управление пользователями (расширить), настройки анализа, логи действий.

### 12. Интеграция с AI
- OpenAI API уже подключён; по ТЗ — именно OpenAI, запросы обезличенные, анализ только по тексту. Gemini можно оставить опционально для настроек.

### 13. Безопасность
- HTTPS, авторизация по токенам (Sanctum для веба, BotUser для бота).
- Временное хранение файлов в памяти сервера и удаление после обработки — реализовать в коде.

---

## 3. Правильный подход к разработке

### Принципы
1. **Не хранить файлы** — скачивать в temp, обрабатывать, удалять.
2. **Один унифицированный текст** — из любого формата (PDF/DOC/картинки) получаем один текст и его отдаём в AI.
3. **Один контур AI** — один сервис «анализ договора»: на входе текст, на выходе структурированная выжимка (и при необходимости JSON для БД).
4. **Ошибки пользователя** — всегда одна и та же фраза по п.7 ТЗ, без детализации форматов.
5. **Поэтапность** — сначала приём и валидация, потом извлечение текста, потом AI, потом хранение и админка.

### Зависимости этапов
```
Этап 1 (файлы) → Этап 2 (текст) → Этап 3 (AI) → Этап 4 (БД + админка) → Этап 5 (выдача + безопасность)
```

---

## 4. Этапы разработки

### Этап 1: Обработчик файлов в боте
- В webhook обрабатывать не только `message.text`, но и `message.document`, `message.photo`.
- Валидация: только PDF, DOC, DOCX, JPG, PNG, ZIP (по MIME и расширению).
- Скачивание файла через Telegram Bot API во временную папку (или в память для маленьких).
- ZIP: распаковка, выбор допустимых файлов, приоритет имени с «договор».
- Лимит: например 20 MB на файл, 5 фото в одном «наборе» (по ТЗ).
- При любом несоответствии или ошибке чтения — ответ: «Пожалуйста, загрузите договор или выбранные страницы договора.» и удаление временных файлов.
- Класс/сервис: `DocumentUploadService` или `ContractFileHandler`.

### Этап 2: Извлечение текста из документов
- PDF: цифровой текст (pdftotext / Smalot\PdfParser или аналог); сканы — OCR (Tesseract или облачный).
- DOC/DOCX: PhpOffice\PhpWord.
- JPG/PNG: OCR (Tesseract).
- На выходе — одна строка/текст для передачи в AI. При неудаче извлечения считать «нечитаемым» и отдавать стандартное сообщение об ошибке (п.7 ТЗ).
- Сервис: `DocumentTextExtractorService` (или разбить на PdfExtractor, DocxExtractor, ImageOcrService и обёртку).

### Этап 3: AI-анализ договора
- Выбрать активную модель для анализа (например из AiModel с пометкой «для договоров» или настройка в админке).
- Промпт: система + пользователь; в контенте — извлечённый текст; инструкция: выдать структурированную выжимку по 16 пунктам ТЗ, без юридической оценки.
- Ответ AI парсить в структуру (список пунктов или JSON) для хранения и для выдачи в Telegram.
- Сервис: `ContractAnalysisService` (использует AiService + текст от Этапа 2).

### Этап 4: Хранение результатов и админ-панель
- Миграция: таблица `contract_analyses` (id, bot_user_id, telegram_bot_id, summary_text, summary_json, created_at и т.д.). Без хранения файлов и путей к файлам.
- После успешного анализа — сохранить запись, привязать к BotUser.
- Планировщик или команда: удаление записей старше 6 месяцев.
- Админ-панель: раздел «История анализов» (список, фильтр по пользователю/дате), просмотр результата (текст + JSON).
- Управление пользователями: уже есть запросы доступа; при необходимости — явное удаление из белого списка.
- Настройки анализа: модель по умолчанию, лимит фото, срок хранения (опционально).
- Логи действий: таблица `admin_action_logs` и запись ключевых действий (кто одобрил, кто загрузил документ, ошибки).

### Этап 5: Выдача результата в Telegram и безопасность
- После анализа отправить пользователю в чат: текст выжимки (краткий или расширенный — по настройке или кнопкам).
- Убедиться, что временные файлы удаляются в любом исходе (success/exception).
- Проверить: только HTTPS, токены, без сохранения копий документов.

---

## 5. Рекомендуемый порядок задач

1. **Константы и сообщения**  
   Вынести в конфиг или класс константу текста ошибки загрузки: «Пожалуйста, загрузите договор или выбранные страницы договора.»

2. **Webhook: ветка «документ/фото»**  
   В `TelegramWebhookController`: если пришло `document` или `photo` и пользователь approved admin — вызвать обработчик файлов (пока можно заглушкой с ответом об ошибке или «в разработке»).

3. **Валидация и скачивание файлов**  
   Реализовать скачивание по `file_path` Telegram API, проверку типа/размера, для ZIP — распаковку и отбор файлов.

4. **Библиотеки извлечения текста**  
   Добавить в composer: PDF (например smalot/pdfparser), DOCX (phpoffice/phpword), OCR (tesseract или обёртка). Реализовать извлечение по типам.

5. **ContractAnalysisService**  
   Промпт по п.6 ТЗ, вызов AiService, разбор ответа в структуру.

6. **Миграция и модель ContractAnalysis**  
   Сохранение результата, привязка к пользователю и боту.

7. **Интеграция в webhook**  
   Цепочка: файл → валидация → извлечение текста → анализ → сохранение → отправка выжимки в чат. Обработка исключений и единое сообщение об ошибке.

8. **Админ-панель: история анализов и логи**  
   CRUD не нужен для анализов (только просмотр и автоочистка). Настройки и логи — по ТЗ.

9. **Очистка старых анализов**  
   Schedule или команда `contract:cleanup` по сроку 6 месяцев.

10. **Финальная проверка**  
    Соответствие п.7 (ошибки), п.9 (не храним файлы), п.13 (временные файлы, удаление).

---

## 6. Файловая структура (рекомендуемая)

```
app/
  Http/Controllers/Api/
    TelegramWebhookController.php   # вызов сервисов загрузки и анализа
  Services/
    Contract/
      ContractFileHandler.php       # приём, валидация, ZIP, скачивание
      DocumentTextExtractor.php     # PDF, DOCX, OCR
      ContractAnalysisService.php   # AI-анализ, промпт, парсинг выжимки
  Models/
    ContractAnalysis.php
database/migrations/
  xxxx_create_contract_analyses_table.php
  xxxx_create_admin_action_logs_table.php  # при необходимости
config/
  contract.php                     # сообщение об ошибке, лимиты, срок хранения
```

---

## 7. Безопасность (ТЗ п.13) — реализовано

- **HTTPS/TLS**: обеспечивается на уровне веб-сервера (Nginx/Apache). Админ-панель только по HTTPS.
- **Авторизация**: веб — Sanctum (Bearer); бот — проверка одобренного BotUser.
- **Временные файлы**: скачивание во временную папку, удаление в `finally` после обработки (успех или ошибка). Исходные файлы не сохраняются.
- **Шифрование персональных данных**: опционально для полей BotUser (first_name, last_name, username). Включение: `CONTRACT_ENCRYPT_BOT_USER_PII=true` в .env. Используется cast `EncryptedIfConfigured` (при выключенном шифровании существующие записи остаются в открытом виде).

---

Дальше можно начинать с **Этапа 1**: добавить константу сообщения об ошибке и обработку `document`/`photo` в webhook с вызовом будущего `ContractFileHandler`.
